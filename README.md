# my-rpc-framework
基于Netty、Zookeeper、Kryo实现的简易RPC框架
1. 基于Netty进行网络编程，提高了系统稳定性和开发速度 
2. 使用动态代理方式，屏蔽远程方法调用的细节 
3. 自定义消息格式，通过Kryo进行序列化，解决了JDK序列化方法效率低、不安全的问题 
4. 通过使用zookeeper作为注册中心，实现服务地址的注册与查找 
5. 使用一致性哈希算法和随机负载均衡算法实现客户端调用远程服务时负载均衡，避免单个服务器响应同一请求 
6. 通过设置Gzip压缩，提高了网络传输的速度
#### 实现RPC框架的目的是

屏蔽网络编程细节，实现调用远程方法就跟调用本地一样简单

#### RPC的通信流程

首先由于RPC用于业务之间的数据交互，需要保证其可靠性，RPC一般采用TCP来进行传输。

在网络中传输的数据必须是二进制数据，所以需要对参数进行序列化，数据到达服务提供方后需要进行反序列化，即依据协议将数据进行解析。

RPC框架根据调用的服务接口提前生成动态代理实现类，该代理实现类会拦截所有的方法调用，在提供的方法处理逻辑里面完成一整套的远程调用，并把远程调用结果返回给调用方，这样调用方在调用远程方法的时候就获得了像调用本地接口一样的体验

#### 服务发现策略

> 服务发现的本质就是完成了接口跟服务提供者IP的映射

##### 方案一：采用DNS来实现服务发现

> 将所有的服务提供者节点配置在了同一个域名下，调用方可以通过DNS拿到随机的服务提供者的IP

###### 存在的问题：

* 这个IP 端口下线了，服务调用者不能及时摘除服务节点
* 之前已经上线了一部分服务节点，这时突然对这个服务进行扩容，那么新上线

的服务节点不能及时接收到流量

###### 原因

为了提升性能和减少DNS服务的压力，DNS采取了多级缓存机制，一般配置的缓存时间比较长，特别是JVM的默认缓存是永久有效的，所以说服务调用者不能及时感知到服务节点的变化

###### DNS相关

DNS是：1. 一个由分层的DNS服务器实现的分布式数据库 2. 一个使主机能够查询分布式数据库的应用层协议

DNS协议运行在UDP之上 使用53号端口

##### 方案二：使用DNS+负载均衡设备

将域名绑定到这台负载均衡设备

上，通过 DNS 拿到负载均衡的 IP。这样服务调用的时候，服务调用方就可以直接跟 VIP 

建立连接，然后由 VIP 机器完成 TCP 转发。

###### 存在的问题

* 搭建负载均衡设备或 TCP/IP 四层代理，需要额外成本；
* 请求流量都经过负载均衡设备，多经过一次网络传输，会额外浪费些性能；
* 负载均衡添加节点和摘除节点，一般都要手动添加，当大批量扩容和下线时，会有大量的人工操作和生效延迟；
* 我们在服务治理的时候，需要更灵活的负载均衡策略，目前的负载均衡设备的算法还满足不了灵活的需求

##### 方案三：使用Zookeeper实现服务发现

1. 首先在zookeeper创建了根路径，依据接口名+group+版本号+IP组成
2. 在获取服务节点时，为节点注册监听器，设置回调函数，节点信息发生变化时，刷新内存

###### 存在的问题

使用Zookeeper作为注册中心，满足了RPC框架的基本需求，但对于超大规模的服务集群，因为其本身的性能问题难以支持。

###### 原因

Zookeeper最大的特点是强一致性，当连接Zookeeper的节点数量特别多，对Zookeeper的读写特别频繁，ZooKeeper 集群的每个节点的数据每次发生更新操作，都会通知其它 ZooKeeper 节点同时执行更新。这会导致Zookeeper集群性能的下降。
